<?php
$collection = $block->getNewsCollection();
if ($collection['status'] == '1' && $collection['news']->count() != 0): ?>
    <div class="news box">
        <div class="vgNews widget">
            <div class="block-title">
                <strong role="heading" aria-level="2">
                    <h2><?= $block->escapeHtml(__('Latest News')); ?></h2>
                </strong>
            </div>

            <?php if ($collection['news']->count() == 0): ?>
                <p class="noResult"><?= $block->escapeHtml(__('No result Found')); ?></p>
            <?php else: ?>
                <div class="owl-carousel owl-theme">
                    <?php foreach ($collection['news'] as $category): ?>
                        <div class="item<?= empty($category['image']) ? ' noImg' : '' ?>">
                            <p class="newsImage">
                                <?php if (!empty($category['image'])):
                                    if (!filter_var($category['image'], FILTER_VALIDATE_URL)) {
                                        $helper = $block->getHelper();
                                        $getBaseUrl = $helper->getBaseUrl();
                                        $newsImageSrcValue = $getBaseUrl . '/' . $category['image'];
                                    } else {
                                        $newsImageSrcValue = $category['image'];
                                    } ?>
                                    <a href="<?= $block->escapeUrl($block->getUrl('news/view/detail', ['news' => $category['url_identifier']])) ?>">
                                        <img src="<?= $block->escapeUrl($newsImageSrcValue); ?>"
                                             alt="<?= $block->escapeHtmlAttr($category['title']); ?>"
                                             title="<?= $block->escapeHtmlAttr($category['title']); ?>" />
                                    </a>
                                <?php endif; ?>
                            </p>

                            <div class="newsHead">
                                <h3>
                                    <a href="<?= $block->escapeUrl($block->getUrl('news/view/detail', ['news' => $category['url_identifier']])) ?>">
                                        <?= $block->escapeHtml($category['title']); ?>
                                    </a>
                                </h3>
                                <p class="small">
                                    <span><?= $block->escapeHtml(__('Posted on: ')); ?>
                                        <?= $block->escapeHtml(date('m-d-Y H:i:s', strtotime($category['publish_date']))); ?>
                                    </span>

                                    <?php if ($category['category_id'] != '0'):
                                        $newsCategoryIds = explode(',', $category['category_id']);
                                        $categoryName = [];
                                        foreach ($newsCategoryIds as $newsCategoryId) {
                                            $categoryName[] = $block->getNewsCategoryTitle($newsCategoryId);
                                        }
                                        if (!empty($categoryName)): ?>
                                            | <span>
                                                <?= $block->escapeHtml(__('Categories:')); ?>
                                                <?php $no = 0;
                                                foreach ($categoryName as $singleCategory):
                                                    if ($no > 0) {
                                                        echo $block->escapeHtml(', ');
                                                    }
                                                    $no++; ?>
                                                    <a href="<?= $block->escapeUrl($block->getUrl('news/category/view', ['category' => $singleCategory['category_url']])) ?>">
                                                        <?= $block->escapeHtml($singleCategory['title']); ?>
                                                    </a>
                                                <?php endforeach; ?>
                                            </span>
                                        <?php endif;
                                    endif; ?>
                                </p>
                            </div>

                            <p class="newsDesc">
                                <?= $block->escapeHtml(
                                    strip_tags(
                                        str_replace('{{widget type="Vgroup65\News\Block\Widget\Shownews"}}', '', substr($category['description'], 0, 150))
                                    )
                                ); ?>

                                <?php if (isset($category['description']) && strlen($category['description']) > 150): ?>
                                    <a href="<?= $block->escapeUrl($block->getUrl('news/view/detail', ['news' => $category['url_identifier']])) ?>">
                                        <?= $block->escapeHtml(__('...View More')); ?>
                                    </a>
                                <?php endif; ?>
                            </p>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>

            <a href="<?= $block->escapeUrl($block->getUrl('news')); ?>" class="newsAll">
                <?= $block->escapeHtml(__('See All')); ?>
            </a>
        </div>
    </div>

    <input type="hidden" id="news_auto_rotate"
           value="<?= $block->escapeHtmlAttr($block->getAutoRotateStatus()); ?>" />

    <script>
        require(['owlcarousel'], function () {
            var owl = jQuery('.owl-carousel');
            var auto_rotate = document.getElementById('news_auto_rotate').value;
            var autorotate = (auto_rotate == 0) ? false : true;

            owl.owlCarousel({
                margin: 10,
                nav: false,
                dots: true,
                loop: true,
                autoplay: autorotate,
                responsive: {
                    0: { items: 1 },
                    600: { items: 1 },
                    1000: { items: 1 }
                }
            });
        });
    </script>
<?php endif; ?>
